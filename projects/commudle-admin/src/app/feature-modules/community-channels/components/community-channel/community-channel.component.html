<ng-template #channelDescription>
  <nb-card>
    <nb-card-header>{{ selectedChannel.name }}</nb-card-header>
    <nb-card-body>
      <div [innerHTML]="selectedChannel.description | linky: { sanitizeHtml: true }" class="complete-description"></div>
    </nb-card-body>
  </nb-card>
</ng-template>

<div class="community-channel">
  <header>
    <div class="channel-details">
      <div *ngIf="selectedChannel">
        <p>
          <nb-icon [nbPopoverTrigger]="'hover'" [nbPopover]="channelDescription" icon="info-outline"></nb-icon>
          <span [innerHTML]="selectedChannel.description | linky: { sanitizeHtml: true } | truncatetext: 100"></span>
        </p>
      </div>
    </div>
    <div class="extra-details">
      <fa-icon
        [nbPopoverPlacement]="'bottom'"
        [nbPopover]="pinnedMessagesContainer"
        [nbPopoverContext]="'pinnedMessagesPopover'"
        [icon]="faThumbtack"
        [style]="{ color: 'green' }"
        transform="rotate-45"
        size="lg"
      ></fa-icon>
      <nb-actions>
        <nb-action
          (click)="toggleCommunityListDisplay()"
          *ngIf="hasNotifications"
          [badgeDot]="true"
          [badgePosition]="'top right'"
          [badgeStatus]="'danger'"
          class="channel-list-menu-button"
          icon="menu-arrow"
        >
        </nb-action>
        <nb-action
          (click)="toggleCommunityListDisplay()"
          *ngIf="!hasNotifications"
          class="channel-list-menu-button"
          icon="menu-arrow"
        >
        </nb-action>
        <nb-action icon="people" link="members"></nb-action>
      </nb-actions>
    </div>
  </header>

  <div class="latest-pinned-message" *ngIf="selectedChannel && latestPinnedMessage">
    <div class="author-image">
      <img
        alt="{{ latestPinnedMessage.user.name }}"
        [src]="latestPinnedMessage.user.avatar"
        title="{{ latestPinnedMessage.user.name }}"
      />
    </div>
    <div class="author-details-container">
      <div class="author-details">
        <p>
          <strong>{{ latestPinnedMessage.user.name }}</strong>
          &nbsp;
          <small>{{ moment(latestPinnedMessage.created_at).format('h:mm A, dddd Do MMM, YYYY ') }}</small>
          &nbsp;
          <small><em *ngIf="latestPinnedMessage.edited">(edited)</em></small>
        </p>
      </div>
      <div
        [innerHTML]="
          latestPinnedMessage.content
            | linky: { sanitizeHtml: false, mention: 'twitter', replaceFn: highlightUserMentions }
        "
        class="content com-line-clamp-1"
      ></div>
    </div>
    <div class="message-controls">
      <fa-icon *ngIf="isAdmin" (click)="removePinnedMessage(latestPinnedMessage)" [icon]="faWindowClose"></fa-icon>
      <!-- <button (click)="scrollToMessage(latestPinnedMessage)" nbButton outline size="tiny" status="info">Jump</button> -->
    </div>
  </div>

  <main [ngStyle]="{ height: latestPinnedMessage ? 'calc(100% - 6.0rem)' : 'calc(100% - 2.5rem)' }" *ngIf="discussion">
    <div class="discussion">
      <app-discussion-community-channel [discussion]="discussion"></app-discussion-community-channel>
    </div>
    <div class="resources">
      <router-outlet></router-outlet>
    </div>
  </main>

  <main *ngIf="!discussion && notFound" class="not-found">
    <p>
      <nb-icon icon="alert-circle-outline"></nb-icon>
      <br />
      This channel is either private or does not exist! Please check with the organizers of the selected community
    </p>
  </main>
</div>

<ng-template #pinnedMessagesContainer>
  <nb-card class="pinned-messages-container">
    <nb-card-header>Pinned Messages</nb-card-header>
    <nb-card-body>
      <nb-list>
        <nb-list-item *ngFor="let pinnedMessage of pinnedMessages">
          <div class="message">
            <div class="author-image">
              <img
                alt="{{ pinnedMessage.user.name }}"
                src="{{ pinnedMessage.user.avatar }}"
                title="{{ pinnedMessage.user.name }}"
              />
            </div>
            <div class="author-details-container">
              <div class="author-details">
                <p>
                  <strong>{{ pinnedMessage.user.name }}</strong>
                  &nbsp;
                  <small>{{ moment(pinnedMessage.created_at).format('h:mm A, dddd Do MMM, YYYY ') }}</small>
                  &nbsp;
                  <small><em *ngIf="pinnedMessage.edited">(edited)</em></small>
                </p>
              </div>
              <div
                [innerHTML]="
                  pinnedMessage.content
                    | linky: { sanitizeHtml: false, mention: 'twitter', replaceFn: highlightUserMentions }
                "
                class="content"
              ></div>
            </div>
          </div>
          <div class="message-controls">
            <fa-icon (click)="removePinnedMessage(pinnedMessage)" [icon]="faWindowClose"></fa-icon>
            <!-- <button (click)="scrollToMessage(pinnedMessage)" nbButton outline size="tiny" status="info">Jump</button> -->
          </div>
        </nb-list-item>
      </nb-list>
    </nb-card-body>
  </nb-card>
</ng-template>
