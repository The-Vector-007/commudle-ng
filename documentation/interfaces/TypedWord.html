<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>commudle-ng documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css" media="(prefers-color-scheme: dark)">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">commudle-ng documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  TypedWord</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>projects/shared-modules/mention/directives/mention-directive/mention.directive.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#endIndex" 
>
                                            endIndex
                                        </a>
                                </li>
                                <li>
                                        <a href="#startIndex" 
>
                                            startIndex
                                        </a>
                                </li>
                                <li>
                                        <a href="#value" 
>
                                            value
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="endIndex"></a>
                                        <span class="name "><b>endIndex</b>
                                            <a href="#endIndex">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>endIndex:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="startIndex"></a>
                                        <span class="name "><b>startIndex</b>
                                            <a href="#startIndex">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>startIndex:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="value"></a>
                                        <span class="name "><b>value</b>
                                            <a href="#value">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>value:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Directive, ElementRef, HostListener, ViewContainerRef, ComponentFactoryResolver, ComponentRef } from &#x27;@angular/core&#x27;;
import { SuggestionBoxComponent } from &#x27;projects/shared-modules/mention/components/suggestion-box/suggestion-box.component&#x27;;
import { MentionService } from &#x27;projects/shared-modules/mention/service/mention.service&#x27;;
import { Subscription } from &#x27;rxjs&#x27;;
import { getCaretCoordinates } from &#x27;projects/shared-modules/mention/utils/textarea-caret-position&#x27;;

@Directive({
  selector: &#x27;[appMention]&#x27;
})
export class MentionDirective {

  componentRef: ComponentRef&lt;SuggestionBoxComponent&gt;;
  triggerCharacter &#x3D; null;
  nativeElement: HTMLTextAreaElement | HTMLInputElement;
  taggableEntities: any[] &#x3D; [];
  selectedEntity: any;
  subscriptions: Subscription[] &#x3D; [];
  private coords: { top: number, left: number } &#x3D; { top: 0, left: 0 };
  clickedOnBox: boolean &#x3D; false;

  constructor(
    private inputElementRef: ElementRef,
    public _viewContainerRef: ViewContainerRef,
    private _componentResolver: ComponentFactoryResolver,
    private mentionService: MentionService
  ) {
    this.nativeElement &#x3D; inputElementRef.nativeElement;
  }

  ngOnDestroy(): void {
    this.subscriptions.forEach((value) &#x3D;&gt; value.unsubscribe());
  }

  onItemHover(entity: any) {
    if (this.componentRef) {
      this.componentRef.instance.selectedEntity &#x3D; entity;
      this.selectedEntity &#x3D; entity;
    }
  }

  onItemClicked(entity: any) {
    this.autoComplete(entity);
    this.nativeElement.focus();
    this.selectedEntity &#x3D; &quot;&quot;;
    if (this.componentRef) {
      this.componentRef.destroy();
    }
  }

  @HostListener(&#x27;blur&#x27;, [&#x27;$event&#x27;]) //if text area gets out of focus remove autocomplete box
  onOutOfFocus(event: any) {
    if (!this.clickedOnBox &amp;&amp; this.componentRef) {
      this.componentRef.destroy();
    }
    this.clickedOnBox &#x3D; false;
  }

  @HostListener(&#x27;keydown&#x27;, [&#x27;$event&#x27;])
  currentKey(event: KeyboardEvent) {

    if (this.componentRef) {

      switch (event.key) {
        case &#x27;Enter&#x27;: {
          if (this.selectedEntity) {

            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();

            this.autoComplete(this.selectedEntity);
            this.nativeElement.focus();
            this.componentRef.destroy()
            this.selectedEntity &#x3D; &quot;&quot;;// alert here
          }

          if (this.nativeElement instanceof HTMLTextAreaElement) {
            return false;
          }

          break;
        }
        case &#x27;ArrowUp&#x27;: {

          let currentSelectedIndex &#x3D; this.taggableEntities.indexOf(this.selectedEntity);
          if (currentSelectedIndex &#x3D;&#x3D;&#x3D; 0) {
            this.componentRef.instance.selectedEntity &#x3D; this.taggableEntities[this.taggableEntities.length - 1];
            this.selectedEntity &#x3D; this.taggableEntities[this.taggableEntities.length - 1];
          }
          else {
            this.componentRef.instance.selectedEntity &#x3D; this.taggableEntities[currentSelectedIndex - 1];
            this.selectedEntity &#x3D; this.taggableEntities[currentSelectedIndex - 1];
          }

          event.preventDefault();

          break;
        }
        case &#x27;ArrowDown&#x27;: {
          let currentSelectedIndex &#x3D; this.taggableEntities.indexOf(this.selectedEntity);
          if (currentSelectedIndex &#x3D;&#x3D;&#x3D; this.taggableEntities.length - 1) {
            this.componentRef.instance.selectedEntity &#x3D; this.taggableEntities[0];
            this.selectedEntity &#x3D; this.taggableEntities[0];
          }
          else {
            this.componentRef.instance.selectedEntity &#x3D; this.taggableEntities[currentSelectedIndex + 1];
            this.selectedEntity &#x3D; this.taggableEntities[currentSelectedIndex + 1];
          }

          event.preventDefault();

          break;
        }
      }

      setTimeout(() &#x3D;&gt; this.scrollSelectedIntoView(), 1);

    }

  }

  autoComplete(entity: any) {

    let currentWordTyped &#x3D; this.getCurrentWord();

    let entityName: string;
    if (entity.type &#x3D;&#x3D;&#x3D; &#x27;users&#x27;) {
      entityName &#x3D; this.triggerCharacter + entity.username;
    }
    else {
      entityName &#x3D; entity.name;
    }

    if (entityName.length &gt;&#x3D; currentWordTyped.value.slice(1).length) {

      let currentTextInputValue &#x3D; this.nativeElement.value;

      let newTextInputValue &#x3D; &quot;&quot;;
      let newCursorPosition &#x3D; 0;

      let addText: string &#x3D; entityName;

      switch (entity.type) {
        case &#x27;users&#x27;: {
          newTextInputValue &#x3D; this.newTextInput(addText, currentTextInputValue, currentWordTyped);
          break;
        }

        case &#x27;channels&#x27;: {
          addText &#x3D; &#x60;&lt;a href&#x3D;&quot;https://commudle.com/communities/${entity.kommunity_slug}/channels/app/${entity.id}&quot;&gt;${entityName}&lt;/a&gt;&#x60;;
          newTextInputValue &#x3D; this.newTextInput(addText, currentTextInputValue, currentWordTyped);
          break;
        }

        case &#x27;events&#x27;: {
          addText &#x3D; &#x60;&lt;a href&#x3D;&quot;https://commudle.com/communities/${entity.kommunity_slug}/events/${entity.slug}&quot;&gt;${entityName}&lt;/a&gt;&#x60;;
          newTextInputValue &#x3D; this.newTextInput(addText, currentTextInputValue, currentWordTyped);
          break;
        }

        default: {
          addText &#x3D; &#x60;&lt;a href&#x3D;&quot;https://commudle.com/${entity.type}/${entity.slug}&quot;&gt;${entityName}&lt;/a&gt;&#x60;;
          newTextInputValue &#x3D; this.newTextInput(addText, currentTextInputValue, currentWordTyped);
        }
      }

      newCursorPosition &#x3D; currentWordTyped.startIndex + addText.length + 1;

      this.nativeElement.value &#x3D; newTextInputValue;
      this.nativeElement.selectionStart &#x3D; newCursorPosition;
      this.nativeElement.selectionEnd &#x3D; newCursorPosition;

      //updates angular binding
      const event &#x3D; new Event(&#x27;input&#x27;, {
        bubbles: true,
        cancelable: false
      });
      this.nativeElement.dispatchEvent(event)
    }

  }

  newTextInput(text: string, currentTextInputValue: string, currentWordTyped: TypedWord): string {
    return currentTextInputValue.slice(0, currentWordTyped.startIndex) + text + &quot; &quot; + currentTextInputValue.slice(currentWordTyped.endIndex + 1);
  }

  @HostListener(&#x27;input&#x27;, [&#x27;$event&#x27;])
  currentString() {

    let wordBeingTyped &#x3D; this.getCurrentWord().value.toLowerCase();

    this.setTriggerCharacter(wordBeingTyped);

    if (wordBeingTyped.startsWith(this.triggerCharacter)) {

      const query &#x3D; wordBeingTyped.slice(1);

      if (query.length) {
        switch (this.triggerCharacter) {

          case &#x27;@&#x27;: {
            this.subscriptions.push(
              this.mentionService.getUsers(query).subscribe((data: any) &#x3D;&gt; {
                this.displayComponent(data);
              })
            );
            break;
          }

          case &#x27;!&#x27;: {
            this.subscriptions.push(
              this.mentionService.getOthers(query).subscribe((data: any) &#x3D;&gt; {
                this.displayComponent(data);
              })
            );
            break;
          }

          default: {
            return this.taggableEntities &#x3D; []
          }

        }
      }

    }
    else {

      setTimeout(() &#x3D;&gt; {
        if (this.componentRef) {
          this.componentRef.destroy()
        }
      }, 500)

      if (this.selectedEntity) {
        this.selectedEntity &#x3D; &quot;&quot;;
      }
    }

  }

  displayComponent(data: any) {

    const results: any[] &#x3D; [];

    for (const entity in data) {
      for (const index in data[entity]) {
        data[entity][index][&quot;type&quot;] &#x3D; entity;
        results.push(data[entity][index])
      }
    }

    this.taggableEntities &#x3D; results;

    if (this.taggableEntities.length) {
      this.loadComponent();
      window.requestAnimationFrame(() &#x3D;&gt; this.checkBounds())
      this.componentRef.instance.taggableEntities &#x3D; this.taggableEntities;
    }
    else {
      if (this.componentRef) {
        this.componentRef.destroy();
      }
    }

  }

  checkBounds() {
    let left &#x3D; this.coords.left, top &#x3D; this.coords.top;
    const boundsHorizontal &#x3D; this.componentRef.location.nativeElement.firstChild.getBoundingClientRect();
    const boundsVertical &#x3D; this.componentRef.location.nativeElement.firstChild.firstChild.getBoundingClientRect();
    const navbarHeight &#x3D; 56;

    let dropUp: boolean &#x3D; true;
    let lineHeight: number &#x3D; 0;

    //If it goes off up or down
    if (boundsVertical.bottom - navbarHeight &lt; boundsVertical.height) {
      top +&#x3D; boundsVertical.height;
      dropUp &#x3D; false;
      const parentStyles &#x3D; window.getComputedStyle(this.nativeElement);
      lineHeight &#x3D; parseFloat(parentStyles.lineHeight);
    }

    //if it goes off on right side
    if (boundsHorizontal.left + boundsHorizontal.width &gt; document.documentElement.clientWidth) {
      left -&#x3D; boundsHorizontal.left + boundsHorizontal.width - document.documentElement.clientWidth + 10;
    }

    this.positionElement(left, top, dropUp, lineHeight);
  }

  setTriggerCharacter(word: string) {

    switch (word.charAt(0)) {

      case &#x27;@&#x27;: {
        this.triggerCharacter &#x3D; &#x27;@&#x27;;
        break;
      }

      case &#x27;!&#x27;: {
        this.triggerCharacter &#x3D; &#x27;!&#x27;;
        break;
      }

      default: {
        this.triggerCharacter &#x3D; null;
      }

    }

  }

  getCurrentWord(): TypedWord {

    let cursorLocation &#x3D; this.nativeElement.selectionStart;
    let text &#x3D; this.nativeElement.value;

    let word: string &#x3D; &quot;&quot;;

    let i: number;
    for (i &#x3D; cursorLocation - 1; i &gt;&#x3D; 0 &amp;&amp; text[i] !&#x3D;&#x3D; &#x27; &#x27;; i--) {
      word +&#x3D; text[i];
    }

    word &#x3D; word.split(&quot;&quot;).reverse().join(&quot;&quot;);

    let startIndex &#x3D; i + 1; //&#x27;@&#x27; position
    let endIndex &#x3D; cursorLocation - 1; // last character position

    return {
      value: word,
      startIndex,
      endIndex
    }
  }

  scrollSelectedIntoView() {
    const listElement &#x3D; this.componentRef.location.nativeElement.firstChild.firstChild.querySelector(&#x27;.selected&#x27;);
    if (listElement) {
      this.scrollIntoView(this.componentRef.location.nativeElement.firstChild.firstChild, listElement, 0, 0);
    }
  }

  scrollIntoView(container: HTMLUListElement, listItem: HTMLLIElement, extraBottom: number, extraTop: number) {
    let cTop &#x3D; container.scrollTop;
    let cBottom &#x3D; cTop + container.clientHeight;

    let eTop &#x3D; listItem.offsetTop;
    let eBottom &#x3D; eTop + listItem.clientHeight;

    if (eTop &lt; cTop) {
      container.scrollTop -&#x3D; (cTop - eTop) + extraBottom;
    }
    else if (eBottom &gt; cBottom) {
      container.scrollTop +&#x3D; (eBottom - cBottom) + extraTop;
    }
  }

  loadComponent() {
    const componentFactory &#x3D; this._componentResolver.resolveComponentFactory(SuggestionBoxComponent);
    const viewContainerRef &#x3D; this._viewContainerRef;
    viewContainerRef.clear();
    this.componentRef &#x3D; viewContainerRef.createComponent&lt;SuggestionBoxComponent&gt;(componentFactory);

    this.coords &#x3D; getCaretCoordinates(this.nativeElement, this.nativeElement.selectionStart);
    this.coords.top +&#x3D; this.nativeElement.offsetTop - this.nativeElement.scrollTop + 5;
    this.coords.left +&#x3D; this.nativeElement.offsetLeft - this.nativeElement.scrollLeft + 5;
    this.positionElement(this.coords.left, this.coords.top);

    this.componentRef.instance.selectedEntity &#x3D; this.taggableEntities[0]; // 1st item will be automatically highlighted
    this.selectedEntity &#x3D; this.taggableEntities[0];

    this.subscriptions.push(
      this.componentRef.instance.itemClick.subscribe(() &#x3D;&gt; {
        this.clickedOnBox &#x3D; true;
      })
    );

    this.subscriptions.push(
      this.componentRef.instance.selectedItemEvent.subscribe((data: any) &#x3D;&gt; {
        if (data.eventType &#x3D;&#x3D;&#x3D; &quot;click&quot;) {
          this.onItemClicked(data.entity);
        }
        else if (data.eventType &#x3D;&#x3D;&#x3D; &quot;hover&quot;) {
          this.onItemHover(data.entity);
        }
      })
    )
  }

  positionElement(left: number, top: number, dropUp: boolean &#x3D; true, lineHeight: number &#x3D; 0) {
    top +&#x3D; dropUp ? 0 : lineHeight;
    this.componentRef.location.nativeElement.firstChild.style.position &#x3D; &quot;absolute&quot;;
    this.componentRef.location.nativeElement.firstChild.style.left &#x3D; left + &#x27;px&#x27;;
    this.componentRef.location.nativeElement.firstChild.style.top &#x3D; top + &#x27;px&#x27;;
  }

}

interface TypedWord {
  value: string;
  startIndex: number;
  endIndex: number;
}
</code></pre>
    </div>
</div>







                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'TypedWord.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
